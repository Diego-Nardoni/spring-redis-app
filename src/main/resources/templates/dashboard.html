<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Architecture POC Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card { transition: transform 0.2s; }
        .status-card:hover { transform: translateY(-2px); }
        .metric-value { font-size: 2rem; font-weight: bold; }
        .container-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .refresh-btn { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .test-result { max-height: 400px; overflow-y: auto; }
        .cache-warning { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-cloud"></i> AWS Architecture POC Dashboard
            </span>
            <span class="navbar-text" th:text="'Last Updated: ' + ${timestamp}"></span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Architecture Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card container-info">
                    <div class="card-body text-center">
                        <h2><i class="fas fa-server"></i> Container Information</h2>
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Container ID</h5>
                                <p class="metric-value" th:text="${containerInfo}"></p>
                            </div>
                            <div class="col-md-4">
                                <h5>Client IP</h5>
                                <p class="metric-value" th:text="${clientIp}"></p>
                            </div>
                            <div class="col-md-4">
                                <h5>Architecture Status</h5>
                                <p class="metric-value">
                                    <span th:text="${status.healthyCount} + '/4'"></span>
                                    <span th:if="${status.allHealthy}" class="text-success">✅</span>
                                    <span th:unless="${status.allHealthy}" class="text-warning">⚠️</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Component Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card h-100" th:classappend="'border-' + ${status.containerStatus.statusColor}">
                    <div class="card-header" th:classappend="'bg-' + ${status.containerStatus.statusColor} + ' text-white'">
                        <h6 class="mb-0">
                            <span th:text="${status.containerStatus.statusIcon}"></span>
                            <span th:text="${status.containerStatus.name}"></span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text" th:text="${status.containerStatus.details}"></p>
                        <small class="text-muted" th:if="${status.containerStatus.responseTime > 0}">
                            Response: <span th:text="${status.containerStatus.responseTime}"></span>ms
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card h-100" th:classappend="'border-' + ${status.redisStatus.statusColor}">
                    <div class="card-header" th:classappend="'bg-' + ${status.redisStatus.statusColor} + ' text-white'">
                        <h6 class="mb-0">
                            <span th:text="${status.redisStatus.statusIcon}"></span>
                            <span th:text="${status.redisStatus.name}"></span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text" th:text="${status.redisStatus.details}"></p>
                        <small class="text-muted" th:if="${status.redisStatus.responseTime > 0}">
                            Response: <span th:text="${status.redisStatus.responseTime}"></span>ms
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card h-100" th:classappend="'border-' + ${status.sessionStatus.statusColor}">
                    <div class="card-header" th:classappend="'bg-' + ${status.sessionStatus.statusColor} + ' text-white'">
                        <h6 class="mb-0">
                            <span th:text="${status.sessionStatus.statusIcon}"></span>
                            <span th:text="${status.sessionStatus.name}"></span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text" th:text="${status.sessionStatus.details}"></p>
                        <small class="text-muted" th:if="${status.sessionStatus.responseTime > 0}">
                            Response: <span th:text="${status.sessionStatus.responseTime}"></span>ms
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card h-100" th:classappend="'border-' + ${status.cloudFrontStatus.statusColor}">
                    <div class="card-header" th:classappend="'bg-' + ${status.cloudFrontStatus.statusColor} + ' text-white'">
                        <h6 class="mb-0">
                            <span th:text="${status.cloudFrontStatus.statusIcon}"></span>
                            <span th:text="${status.cloudFrontStatus.name}"></span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text" th:text="${status.cloudFrontStatus.details}"></p>
                        <small class="text-muted" th:if="${status.cloudFrontStatus.responseTime > 0}">
                            Response: <span th:text="${status.cloudFrontStatus.responseTime}"></span>ms
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Architecture Diagram -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-sitemap"></i> Architecture Flow</h5>
                    </div>
                    <div class="card-body architecture-diagram text-center">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <div class="p-3 bg-primary text-white rounded">
                                    <i class="fas fa-globe fa-2x"></i>
                                    <br>User
                                </div>
                            </div>
                            <div class="col-md-1">
                                <i class="fas fa-arrow-right fa-2x text-primary"></i>
                            </div>
                            <div class="col-md-2">
                                <div class="p-3 bg-info text-white rounded">
                                    <i class="fas fa-cloud fa-2x"></i>
                                    <br>CloudFront
                                </div>
                            </div>
                            <div class="col-md-1">
                                <i class="fas fa-arrow-right fa-2x text-primary"></i>
                            </div>
                            <div class="col-md-2">
                                <div class="p-3 bg-success text-white rounded">
                                    <i class="fas fa-balance-scale fa-2x"></i>
                                    <br>ALB
                                </div>
                            </div>
                            <div class="col-md-1">
                                <i class="fas fa-arrow-right fa-2x text-primary"></i>
                            </div>
                            <div class="col-md-2">
                                <div class="p-3 bg-warning text-white rounded">
                                    <i class="fas fa-server fa-2x"></i>
                                    <br>ECS
                                </div>
                            </div>
                            <div class="col-md-1">
                                <i class="fas fa-arrow-down fa-2x text-primary"></i>
                            </div>
                        </div>
                        <div class="row mt-3 justify-content-end">
                            <div class="col-md-2">
                                <div class="p-3 bg-danger text-white rounded">
                                    <i class="fas fa-database fa-2x"></i>
                                    <br>Redis
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-vial"></i> Architecture Tests</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="testSession()">
                                    <i class="fas fa-user-clock"></i> Test Session
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100 mb-2" onclick="testRedis()">
                                    <i class="fas fa-database"></i> Test Redis
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100 mb-2" onclick="testLoadBalancing()">
                                    <i class="fas fa-balance-scale"></i> Test Load Balancing
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100 mb-2" onclick="testCloudFront()">
                                    <i class="fas fa-cloud"></i> Test CloudFront
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults">
                            <p class="text-muted">Click on test buttons above to see results...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn btn-primary btn-lg refresh-btn" onclick="location.reload()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function testSession() {
            showLoading('Testing session persistence...');
            fetch('/api/session/test')
                .then(response => response.json())
                .then(data => {
                    showResult('Session Test', data, 'success');
                })
                .catch(error => {
                    showResult('Session Test', {error: error.message}, 'danger');
                });
        }

        function testRedis() {
            showLoading('Testing Redis connectivity...');
            fetch('/api/session/redis/test')
                .then(response => response.json())
                .then(data => {
                    showResult('Redis Test', data, data.status === 'success' ? 'success' : 'danger');
                })
                .catch(error => {
                    showResult('Redis Test', {error: error.message}, 'danger');
                });
        }

        function testLoadBalancing() {
            showLoading('Testing load balancing (multiple requests)...');
            const requests = [];
            for (let i = 0; i < 5; i++) {
                requests.push(fetch('/api/container').then(r => r.text()));
            }
            
            Promise.all(requests)
                .then(containers => {
                    const uniqueContainers = [...new Set(containers)];
                    const result = {
                        totalRequests: containers.length,
                        uniqueContainers: uniqueContainers.length,
                        containers: containers,
                        loadBalancing: uniqueContainers.length > 1 ? 'Working' : 'Single Container'
                    };
                    showResult('Load Balancing Test', result, uniqueContainers.length > 1 ? 'success' : 'warning');
                })
                .catch(error => {
                    showResult('Load Balancing Test', {error: error.message}, 'danger');
                });
        }

        function testCloudFront() {
            showLoading('Testing CloudFront headers...');
            fetch('/api/status')
                .then(response => {
                    const headers = {};
                    for (let [key, value] of response.headers.entries()) {
                        if (key.toLowerCase().includes('cloudfront') || key.toLowerCase().includes('cache')) {
                            headers[key] = value;
                        }
                    }
                    return response.json().then(data => ({...data, headers}));
                })
                .then(data => {
                    showResult('CloudFront Test', data, 'info');
                })
                .catch(error => {
                    showResult('CloudFront Test', {error: error.message}, 'danger');
                });
        }

        function showLoading(message) {
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> ${message}
                </div>
            `;
        }

        function showResult(testName, data, type) {
            const resultHtml = `
                <div class="alert alert-${type}">
                    <h6><i class="fas fa-vial"></i> ${testName} Results:</h6>
                    <pre class="mb-0">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            document.getElementById('testResults').innerHTML = resultHtml;
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('Status updated:', data);
                });
        }, 30000);
    </script>
</body>
</html>
